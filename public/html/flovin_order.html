<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>주문서 - FLOVIN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/css/flovin_order.css" rel="stylesheet">
</head>

<body>
    <div class="wrap">
        <header>
            <div class="logo">FLOVIN</div>
            <div class="title">주문서</div>
        </header>

        <!-- 주문자 정보 -->
        <div class="card grid" style="margin-top:12px;">
            <div class="menu_title"><span>주문자 정보</span><span class="essential">*필수</span></div>
            <div class="row-3">
                <div>
                    <label>성함</label>
                    <input type="text" id="orderName" placeholder="주문자 성함을 적어주세요." />
                </div>
                <div>
                    <label>전화번호</label>
                    <input type="text" id="orderPhone" placeholder="주문자 전화번호를 적어주세요." />
                </div>
                <div>
                    <label>이메일</label>
                    <input type="text" id="orderEmail" placeholder="이메일을 적어주세요." />
                </div>
            </div>
        </div>

        <!-- 메뉴 선택 -->
        <div class="card grid">
            <div class="menu_title"><span>메뉴</span><span class="essential">*필수</span></div>
            <div class="row-1">
                <div>
                        <div class="menu_title2"><span>카테고리 선택</span></div>
                        <select id="category">
                            <option value="">카테고리 선택</option>
                            <option value="dry">Dry (필수)</option>
                            <option value="resin">Resin Set</option>
                            <option value="objet">Objet Set</option>
                            <option value="main">Main Gift</option>
                            <option value="single">Single Gift</option>
                        </select>
                        <div class="menu_title2" style="margin-top: 12px;"><span>상품 선택</span></div>
                        <select id="menu"><option value="">카테고리를 선택해주세요</option></select> 
                </div>
            </div>
            <div class="muted">메뉴 선택 시 아래 <b>주문내역</b>에 추가되고, 배송비 포함 총금액이 갱신돼.</div>
        </div>

        <!-- 주문내역 -->
        <div class="card" style="margin-top:12px;">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
                <div><span class="badge">주문내역</span></div>
                <div class="muted" id="summaryText"></div>
            </div>
        
            <table class="table">
                <thead>
                    <tr>
                        <th>메뉴</th>
                        <th style="width:120px">단가</th>
                        <th style="width:160px">수량</th>
                        <th style="width:100px" class="num">금액</th>
                        <th style="width:80px"></th>
                    </tr>
                </thead>
                <tbody id="itemsBody"><!-- 행 자동 렌더 --></tbody>
            </table>
        
            <div class="actions" style="margin-top:8px;">
                <button class="btn" id="clear">모두 비우기</button>
            </div>
        
            <!-- 소계/배송 요약 -->
            <div style="display:grid; gap:6px; margin-top:12px;">
                <div class="num">소계: <b id="subtotal">0</b> 원</div>
                <div class="num">배송비(<span id="shipName">방문 수령</span>): <b id="shipFee">0</b> 원</div>
                <div class="num">총금액: <b id="grand">0</b> 원</div>
                <div class="num muted" style="font-size:12px;margin-top:4px;">
                    (소계 <span id="sumSub">0</span> + 배송비 <span id="sumShip">0</span>)
                </div>
            </div>
        </div>

        <!-- 배송 방식 선택 -->
        <div class="card grid">
            <div class="menu_title"><span>배송방식</span><span class="essential">*필수</span></div>
            <div class="row">
                <div>
                    <select id="shipping">
                        <option value="방문 수령" data-fee="0">방문 수령</option>
                        <option value="택배" data-fee="4000">택배 (4,000원)</option>
                    </select>
                </div>
                <div style="line-height: 45px; height: 10px;">
                    <span class="muted">* 유리돔은 파손 위험으로 <b>방문 수령만</b> 가능</span>
                </div>
            </div>
        </div>

        <!-- 배송지 -->
        <div class="card grid">
            <div class="menu_title"><span>배송지</span><span class="title_comment">* 방문 수령 시 생략</span></div>
            <div class="row-1">
                <div>
                    <label>우편번호</label>
                    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
                        <input type="text" id="sample3_postcode" placeholder="우편번호" />
                        <button type="button" class="btn" onclick="sample3_execDaumPostcode()">우편번호 찾기</button>
                    </div>
                </div>
                <div>
                    <label>주소</label>
                    <input type="text" id="sample3_address" placeholder="주소" />
                </div>
                <div class="row">
                    <div>
                        <label>상세주소</label>
                        <input type="text" id="sample3_detailAddress" placeholder="상세주소" />
                    </div>
                    <div>
                        <label>참고항목</label>
                        <input type="text" id="sample3_extraAddress" placeholder="참고항목" />
                    </div>
                </div>
                <!-- 임베드 영역 -->
                <div id="wrap">
                    <img src="https://t1.daumcdn.net/postcode/resource/images/close.png" id="btnFoldWrap" alt="접기 버튼"
                        onclick="foldDaumPostcode()">
                </div>
                <div class="muted" style="font-size:12px;">※ 주소검색 창은 페이지 안에 임베드되어 뜬다. 선택하면 자동으로 접힘.</div>
            </div>
        </div>

        <!-- 신랑신부 정보 -->
        <div class="card grid">
            <div class="menu_title">신랑신부 정보</div>
            <div class="row-3">
                <div>
                    <label>신랑 성함</label>
                    <input type="text" id="groomName" placeholder="신랑 성함을 적어주세요." />
                </div>
                <div>
                    <label>신부 성함</label>
                    <input type="text" id="brideName" placeholder="신부 성함을 적어주세요." />
                </div>
                <div>
                    <label>결혼 날짜 / 기념일</label>
                    <input type="text" id="eventDate" placeholder="예: 2025-10-18" />
                </div>
            </div>
        </div>

        <!-- 추가 정보 -->
        <div class="card grid">
            <div class="menu_title">추가 정보</div>
            <textarea id="memo" style="height:120px;" placeholder="요청사항을 적어주세요."></textarea>
        </div>

        <div class="actions" style="margin-top:12px;">
            <button class="btn" id="btnPrint">인쇄 / PDF 저장</button>
        </div>
    </div>

<!-- 주문 스크립트 -->
<script>
    const nf = new Intl.NumberFormat('ko-KR');
    const $ = (s) => document.querySelector(s);

    const items = new Map();
    const fmt = (n) => nf.format(Math.max(0, Number(n) || 0));

    async function loadProducts() {
        const res = await fetch('/data/product.json', { cache: 'no-store' });
        products = await res.json();
    }

    // 카테고리 선택 시 상품 옵션 로드
    function updateMenuOptions(cat) {
        const menu = $('#menu');
        menu.innerHTML = '<option value="">상품 선택</option>';
        if (products[cat]) {
            products[cat].forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.dataset.price = p.price;
                opt.textContent = `${p.name} (${nf.format(p.price)}원)`;
                menu.appendChild(opt);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadProducts();

        $('#category').addEventListener('change', (e) => {
            updateMenuOptions(e.target.value);
        });
    });

        function addOrIncItem(name, price, qty = 1) {
            if (!name) return;
            if (items.has(name)) items.get(name).qty += qty;
            else items.set(name, { name, price: Number(price) || 0, qty: Number(qty) || 1 });
            render();
        }
        function setQty(name, qty) {
            const it = items.get(name); if (!it) return;
            it.qty = Math.max(0, Number(qty) || 0);
            if (it.qty === 0) items.delete(name);
            render();
        }
        function removeItem(name) { items.delete(name); render(); }

        function getTotals() {
            let subtotal = 0;
            items.forEach(it => subtotal += it.price * it.qty);
            const shipOpt = $('#shipping').selectedOptions[0];
            const shipFee = Number(shipOpt?.dataset?.fee) || 0;
            const shipName = shipOpt?.value || '직접수령';
            return { subtotal, shipFee, shipName, grand: subtotal + shipFee };
        }

        function enforceShippingRule() {
            const hasGlassDome = [...items.keys()].includes('유리돔');
            const sel = $('#shipping');
            const courier = sel.querySelector('option[value="택배"]');
            if (hasGlassDome) {
                if (courier) courier.disabled = true;
                if (sel.value === '택배') { sel.value = '직접수령'; alert('유리돔은 파손 위험으로 직접수령만 가능해. 배송방식을 직접수령으로 변경했어.'); }
            } else {
                if (courier) courier.disabled = false;
            }
        }

        function render() {
            enforceShippingRule();

            const tbody = $('#itemsBody');
            tbody.innerHTML = '';
            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${it.name}</td>
                    <td><input class="uprice" data-name="${it.name}" type="number" min="0" step="1" value="${it.price}" /></td>
                    <td>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <button class="btn small" data-action="dec" data-name="${it.name}">-</button>
                        <input class="qtyInput" data-name="${it.name}" type="number" min="0" step="1" value="${it.qty}" style="width:80px" />
                        <button class="btn small" data-action="inc" data-name="${it.name}">+</button>
                    </div>
                    </td>
                    <td class="num">${fmt(it.price * it.qty)}</td>
                    <td class="num"><button class="btn danger small" data-action="del" data-name="${it.name}">삭제</button></td>
        `;
                tbody.appendChild(tr);
            });

            tbody.onclick = (e) => {
                const btn = e.target.closest('button'); if (!btn) return;
                const name = btn.dataset.name; const it = items.get(name); if (!it) return;
                if (btn.dataset.action === 'inc') setQty(name, it.qty + 1);
                if (btn.dataset.action === 'dec') setQty(name, it.qty - 1);
                if (btn.dataset.action === 'del') removeItem(name);
            };
            tbody.oninput = (e) => {
                const qinp = e.target.closest('.qtyInput');
                const pinp = e.target.closest('.uprice');
                if (qinp) setQty(qinp.dataset.name, qinp.value);
                if (pinp) { const it = items.get(pinp.dataset.name); if (it) { it.price = Math.max(0, Number(pinp.value) || 0); render(); } }
            };

            const { subtotal, shipFee, shipName, grand } = getTotals();
            $('#subtotal').textContent = fmt(subtotal);
            $('#shipFee').textContent = fmt(shipFee);
            $('#shipName').textContent = shipName;
            $('#grand').textContent = fmt(grand);
            $('#sumSub').textContent = fmt(subtotal);
            $('#sumShip').textContent = fmt(shipFee);

            const cnt = [...items.values()].reduce((a, b) => a + b.qty, 0);
            $('#summaryText').textContent = cnt ? `총 ${cnt}개 품목` : '항목이 없습니다';
        }

        function onMenuChange() {
            const sel = $('#menu');
            const opt = sel.selectedOptions[0];
            const name = sel.value;
            if (!name) return;
            if (name === '직접입력') {
                const n = (prompt('메뉴명을 입력하세요', '') || '').trim();
                if (!n) { sel.value = ''; return; }
                const p = Number(prompt('가격(원)을 입력하세요', '0'));
                if (!Number.isFinite(p) || p < 0) { sel.value = ''; return; }
                addOrIncItem(n, Math.round(p), 1);
            } else {
                addOrIncItem(name, Number(opt.dataset.price) || 0, 1);
            }
            sel.value = '';
        }

        function onShippingChange() { render(); }
        $('#clear').onclick = () => { items.clear(); render(); };
        $('#menu').addEventListener('change', onMenuChange);
        $('#shipping').addEventListener('change', onShippingChange);
        $('#btnPrint').addEventListener('click', () => window.print());
    </script>

    <!-- 카카오 우편번호 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        // 임베드 컨테이너
        var element_wrap = document.getElementById('wrap');

        function foldDaumPostcode() {
            element_wrap.style.display = 'none';
        }

        function sample3_execDaumPostcode() {
            var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
            new daum.Postcode({
                oncomplete: function (data) {
                    var addr = '';      // 주소
                    var extraAddr = ''; // 참고항목

                    if (data.userSelectedType === 'R') { addr = data.roadAddress; }
                    else { addr = data.jibunAddress; }

                    if (data.userSelectedType === 'R') {
                        if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) { extraAddr += data.bname; }
                        if (data.buildingName !== '' && data.apartment === 'Y') {
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        if (extraAddr !== '') { extraAddr = ' (' + extraAddr + ')'; }
                        document.getElementById("sample3_extraAddress").value = extraAddr;
                    } else {
                        document.getElementById("sample3_extraAddress").value = '';
                    }

                    document.getElementById('sample3_postcode').value = data.zonecode;
                    document.getElementById("sample3_address").value = addr;
                    document.getElementById("sample3_detailAddress").focus();

                    // 창 접기 + 스크롤 복원
                    element_wrap.style.display = 'none';
                    document.body.scrollTop = currentScroll;
                },
                onresize: function (size) { element_wrap.style.height = size.height + 'px'; },
                width: '100%',
                height: '100%'
            }).embed(element_wrap);

            // 보이기
            element_wrap.style.display = 'block';
        }
    </script>
</body>

</html>