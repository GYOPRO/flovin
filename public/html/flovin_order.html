<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title>FLOVIN - 주문서</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../css/flovin_order.css?v=2" rel="stylesheet">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#111827">

    <!-- iOS 홈화면 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FLOVIN">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
</head>

<body>
    <div class="wrap">
        <header>
            <div class="logo">FLOVIN</div>
            <div class="title">주문서</div>
        </header>

        <!-- 주문자 정보 -->
        <div class="card grid" style="margin-top:12px;">
            <div class="menu_title"><span>주문자 정보</span><span class="essential">*필수</span></div>
            <div class="row-3">
                <div>
                    <label>성함</label>
                    <input type="text" id="orderName" placeholder="주문자 성함을 적어주세요." />
                </div>
                <div>
                    <label>전화번호</label>
                    <input type="text" id="orderPhone" placeholder="주문자 전화번호를 적어주세요." />
                </div>
                <div>
                    <label>이메일</label>
                    <input type="text" id="orderEmail" placeholder="이메일을 적어주세요." />
                </div>
            </div>
        </div>

        <!-- 메뉴 선택 (출력 제외) -->
        <div class="card grid no-print">
            <div class="menu_title"><span>메뉴</span><span class="essential">*필수</span></div>
            <div class="row-1">
                <div>
                    <div class="menu_title2"><span>카테고리 선택</span></div>
                    <select id="category">
                        <option value="">카테고리 선택</option>
                        <option value="dry">Dry (필수)</option>
                        <option value="resin">Resin Set</option>
                        <option value="objet">Objet Set</option>
                        <option value="main">Main Gift</option>
                        <option value="single">Single Gift</option>
                    </select>
                    <div class="menu_title2" style="margin-top: 12px;"><span>상품 선택</span></div>
                    <select id="menu">
                        <option value="">카테고리를 선택해주세요</option>
                    </select>
                </div>
            </div>
            <div class="muted">※ 메뉴표에 없는 세트 구성을 원하실 경우, 별도 문의해 주세요!</div>
        </div>

        <!-- 주문내역 -->
        <div class="card" style="margin-top:12px;">
            <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;">
                <div><span class="badge">주문내역</span></div>
                <div class="muted" id="summaryText"></div>
            </div>

            <table class="table">
                <thead>
                    <tr>
                        <th style="width:50%">메뉴</th>
                        <th style="width:12%" class="num">단가</th>
                        <th style="width:10%">수량</th>
                        <th style="width:12%" class="num">금액</th>
                        <th style="width:10%"></th>
                    </tr>
                </thead>
                <tbody id="itemsBody"><!-- 행 자동 렌더 --></tbody>
            </table>

            <div class="actions" style="margin-top:8px;">
                <button class="btn" id="clear">모두 비우기</button>
            </div>

            <!-- 소계/배송 요약 -->
            <div style="display:grid; gap:6px; margin-top:12px;">
                <div class="num">소계: <b id="subtotal">0</b> 원</div>
                <div class="num">배송비(<span id="shipName">방문 수령</span>): <b id="shipFee">0</b> 원</div>
                <div class="num">총금액: <b id="grand">0</b> 원</div>
                <div class="num muted" style="font-size:12px;margin-top:4px;">
                    (소계 <span id="sumSub">0</span> + 배송비 <span id="sumShip">0</span>)
                </div>
            </div>
        </div>

        <!-- 배송 방식 선택 -->
        <div class="card grid">
            <div class="menu_title"><span>배송방식</span><span class="essential">*필수</span></div>
            <div class="row-1">
                <div>
                    <select id="shipping">
                        <option value="방문 수령" data-fee="0">방문 수령</option>
                        <option value="택배" data-fee="4000">택배 (4,000원)</option>
                    </select>
                </div>
            </div>
            <div class="muted">* 유리돔은 파손 위험으로 <b>방문 수령만</b> 가능</div>
        </div>

        <!-- 배송지 -->
        <div class="card grid">
            <div class="menu_title"><span>배송지</span><span class="title_comment">* 방문 수령 시 생략</span></div>

            <div class="row-3">
                <div>
                    <label>받으실 분 성함</label>
                    <input type="text" id="recvName" placeholder="받으실 분 성함을 적어주세요" />
                </div>
                <div>
                    <label>받으실 분 연락처</label>
                    <input type="text" id="recvPhone" placeholder="받으실 분 연락처을 적어주세요" />
                </div>
                <div style="display:flex; align-items:center;">
                    <label style="display:flex;align-items:center;gap:8px; margin:0;">
                        <input type="checkbox" id="sameAsOrder"> 주문자와 동일
                    </label>
                </div>
            </div>

            <div class="muted" style="font-size:12px;">※ 받으실 분 주소를 입력해주세요. ex) 주문자 or 신랑신부</div>

            <div class="row-1">
                <div>
                    <label>우편번호</label>
                    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
                        <input type="text" id="sample3_postcode" placeholder="우편번호" readonly />
                        <button type="button" class="btn" onclick="sample3_execDaumPostcode()">우편번호 찾기</button>
                    </div>
                </div>
                <div>
                    <label>주소</label>
                    <input type="text" id="sample3_address" placeholder="주소" readonly />
                </div>
                <div class="row">
                    <div>
                        <label>상세주소</label>
                        <input type="text" id="sample3_detailAddress" placeholder="상세주소" />
                    </div>
                    <div>
                        <label>참고항목</label>
                        <input type="text" id="sample3_extraAddress" placeholder="참고항목" readonly />
                    </div>
                </div>
                <!-- 카카오 우편번호 임베드 -->
                <div id="wrap">
                    <img src="https://t1.daumcdn.net/postcode/resource/images/close.png" id="btnFoldWrap" alt="접기 버튼"
                        onclick="foldDaumPostcode()">
                </div>
            </div>
        </div>

        <!-- 신랑신부 정보 -->
        <div class="card grid">
            <div class="menu_title">신랑신부 정보<span class="title_comment">* 레진 상품 생략</span></div>
            <div class="row-3">
                <div>
                    <label>신랑 성함</label>
                    <input type="text" id="groomName" placeholder="신랑 성함을 적어주세요." />
                </div>
                <div>
                    <label>신부 성함</label>
                    <input type="text" id="brideName" placeholder="신부 성함을 적어주세요." />
                </div>
                <div>
                    <label>결혼 날짜 / 기념일</label>
                    <input type="text" id="eventDate" placeholder="예: 2025-10-18" />
                </div>
            </div>
        </div>

        <!-- 추가 정보 -->
        <div class="card grid">
            <div class="menu_title">추가 정보</div>
            <textarea id="memo" style="height:120px;" placeholder="요청사항을 적어주세요."></textarea>
        </div>

        <div class="actions" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="btnPrint">PDF 저장</button>
            <button class="btn" id="btnSaveImage">이미지 저장</button>
        </div>
    </div>

    <!-- ====== 출력 폼 ====== -->
    <div id="invoicePrint" aria-hidden="true">
        <div class="sheet">
            <div class="topbar">
                <div>
                    <div class="brand">FLOVIN</div>
                    <div class="tiny">https://flovin.imweb.me</div>
                </div>
                <div class="tag"></div>
            </div>

            <div class="meta">
                <div class="box">
                    <h4>발신자</h4>
                    <div class="kv">
                        <div class="muted">상호명</div>
                        <div>FLOVIN</div>
                        <div class="muted">연락처</div>
                        <div>T. 010-2940-7623</div>
                        <div class="muted">이메일</div>
                        <div>flovin@naver.com</div>
                    </div>
                </div>
                <div class="box">
                    <h4>주문자</h4>
                    <div class="kv">
                        <div class="muted">성함</div>
                        <div id="invBillName">-</div>
                        <div class="muted">연락처</div>
                        <div id="invBillPhone">-</div>
                        <div class="muted">이메일</div>
                        <div id="invBillEmail">-</div>
                    </div>
                </div>
            </div>

            <div class="box" style="margin-bottom:12px;">
                <h4>배송지</h4>
                <div class="kv">
                    <div class="muted">결제/배송 방식</div>
                    <div id="invPayMethod">-</div>
                    <div class="muted">이름</div>
                    <div id="invShipName">-</div>
                    <div class="muted">연락처</div>
                    <div id="invShipPhone">-</div>
                    <div class="muted">배송지</div>
                    <div id="invShipAddr">-</div>
                </div>
            </div>

            <div class="box" style="margin-bottom:12px;">
                <table>
                    <thead>
                        <tr>
                            <th style="width:44%;">내역</th>
                            <th style="width:14%;" class="num">수량</th>
                            <th style="width:18%;" class="num">가격</th>
                            <th style="width:24%;" class="num">총가격</th>
                        </tr>
                    </thead>
                    <tbody id="invItems"></tbody>
                </table>
                <div class="totals">
                    <div class="row">
                        <div>Subtotal</div>
                        <div class="num" id="invSub">₩0</div>
                    </div>
                    <div class="row">
                        <div>Shipping</div>
                        <div class="num" id="invShipFee">₩0</div>
                    </div>
                    <div class="row">
                        <div>Total</div>
                        <div class="num" id="invTotal">₩0</div>
                    </div>
                </div>
            </div>

            <div class="meta2">
                <div class="box">
                    <h4>신랑 성함</h4>
                    <div id="invGroomName">-</div>
                </div>
                <div class="box">
                    <h4>신부 성함</h4>
                    <div id="invBrideName">-</div>
                </div>
                <div class="box">
                    <h4>결혼 날짜 / 기념일</h4>
                    <div id="invEventDate">-</div>
                </div>
            </div>

            <div class="box">
                <h4>추가요청 사항</h4>
                <div id="invNotes" class="tiny">-</div>
            </div>

            <div class="tiny" style="margin-top:10px;">
                Payment Info · Bank: 0000-00-000000 (예금주 FLOVIN) · 문의: 010-2940-7623
            </div>
        </div>
    </div>

    <!-- ================= 스크립트 ================= -->
    <script>
        // PWA SW 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            });
        }

        const nf = new Intl.NumberFormat('ko-KR');
        const $ = (s) => document.querySelector(s);

        const items = new Map();
        window.items = items;

        const fmt = (n) => nf.format(Math.max(0, Number(n) || 0));

        let products = {};
        let dryNameSet = new Set();
        const norm = (s) => (s || '').replace(/\s+/g, '').trim();
        const isDryName = (name) => dryNameSet.has(norm(name));

        async function loadProducts() {
            const res = await fetch('/data/product.json', { cache: 'no-store' });
            products = await res.json();
            dryNameSet = new Set((products?.dry || []).map(p => norm(p.name)));
        }

        function updateMenuOptions(cat) {
            const menu = $('#menu');
            menu.innerHTML = '<option value="">상품 선택</option>';
            if (products[cat]) {
                products[cat].forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.dataset.price = p.price;
                    opt.textContent = `${p.name} (${nf.format(p.price)}원)`;
                    menu.appendChild(opt);
                });
            }
        }

        // 전화번호 포맷
        function formatKRPhoneDigits(digits) {
            digits = (digits || '').replace(/\D/g, '');
            if (digits.startsWith('02')) {
                if (digits.length <= 2) return digits;
                if (digits.length <= 5) return digits.slice(0, 2) + '-' + digits.slice(2);
                const mid = digits.length === 9 ? 3 : (digits.length - 6);
                return digits.slice(0, 2) + '-' + digits.slice(2, 2 + mid) + '-' + digits.slice(2 + mid);
            }
            if (digits.length <= 3) return digits;
            if (digits.length <= 7) return digits.slice(0, 3) + '-' + digits.slice(3);
            if (digits.length <= 10) return digits.slice(0, 3) + '-' + digits.slice(3, 6) + '-' + digits.slice(6);
            return digits.slice(0, 3) + '-' + digits.slice(3, 7) + '-' + digits.slice(7, 11);
        }
        const formatPhoneInput = (el) => el.value = formatKRPhoneDigits(el.value);

        // 주문자와 동일
        function copyRecipient() {
            $('#recvName').value = $('#orderName').value;
            $('#recvPhone').value = formatKRPhoneDigits($('#orderPhone').value);
        }
        function syncRecipientFromOrder() {
            const checked = $('#sameAsOrder').checked;
            if (checked) {
                copyRecipient();
                $('#recvName').readOnly = true;
                $('#recvPhone').readOnly = true;
            } else {
                $('#recvName').readOnly = false;
                $('#recvPhone').readOnly = false;
            }
        }

        // 유리돔 규칙
        const isGlassDome = (name) => typeof name === 'string' && name.includes('유리돔');
        function enforceShippingRule() {
            const hasGlassDome = [...items.keys()].some(isGlassDome);
            const sel = $('#shipping');
            const courier = sel.querySelector('option[value="택배"]');
            if (hasGlassDome) {
                if (courier) courier.disabled = true;
                if (sel.value === '택배') {
                    sel.value = '방문 수령';
                    alert('유리돔은 파손 위험으로 방문 수령만 합니다. 배송방식을 방문 수령으로 변경했어요!.');
                }
            } else {
                if (courier) courier.disabled = false;
            }
        }

        // Dry 단일 선택
        function hasDryInCart() {
            for (const k of items.keys()) if (isDryName(k)) return true;
            return false;
        }
        function removeOtherDryLines(exceptName) {
            for (const k of [...items.keys()]) {
                if (isDryName(k) && norm(k) !== norm(exceptName)) items.delete(k);
            }
        }

        function addOrIncItem(name, price, qty = 1) {
            if (!name) return;
            if (isDryName(name)) {
                if (hasDryInCart() && !items.has(name)) alert('Dry 카테고리 상품은 한 종류만 선택할 수 있어 기존 항목을 교체합니다.');
                removeOtherDryLines(name);
            }
            if (items.has(name)) items.get(name).qty += qty;
            else items.set(name, { name, price: Number(price) || 0, qty: Number(qty) || 1 });
            render();
        }
        function setQty(name, qty) {
            const it = items.get(name); if (!it) return;
            it.qty = Math.max(0, Number(qty) || 0);
            if (it.qty === 0) items.delete(name);
            render();
        }
        function removeItem(name) { items.delete(name); render(); }

        function getTotals() {
            let subtotal = 0;
            items.forEach(it => subtotal += it.price * it.qty);
            const shipOpt = $('#shipping').selectedOptions[0];
            const shipFee = Number(shipOpt?.dataset?.fee) || 0;
            const shipName = shipOpt?.value || '직접수령';
            return { subtotal, shipFee, shipName, grand: subtotal + shipFee };
        }

        function render() {
            enforceShippingRule();
            const tbody = $('#itemsBody');
            tbody.innerHTML = '';
            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${it.name}</td>
          <td class="num">${fmt(it.price)}원</td>
          <td>
            <div style="display:flex;gap:6px;align-items:center;">
              <button class="btn small" data-action="dec" data-name="${it.name}">-</button>
              <input class="qtyInput" data-name="${it.name}" type="number" min="0" step="1" value="${it.qty}" style="width:50px" readonly/>
              <button class="btn small" data-action="inc" data-name="${it.name}">+</button>
            </div>
          </td>
          <td class="num">${fmt(it.price * it.qty)}원</td>
          <td class="num"><button class="btn danger small" data-action="del" data-name="${it.name}">삭제</button></td>
        `;
                tbody.appendChild(tr);
            });

            tbody.onclick = (e) => {
                const btn = e.target.closest('button'); if (!btn) return;
                const name = btn.dataset.name; const it = items.get(name); if (!it) return;
                if (btn.dataset.action === 'inc') setQty(name, it.qty + 1);
                if (btn.dataset.action === 'dec') setQty(name, it.qty - 1);
                if (btn.dataset.action === 'del') removeItem(name);
            };

            const { subtotal, shipFee, shipName, grand } = getTotals();
            $('#subtotal').textContent = fmt(subtotal);
            $('#shipFee').textContent = fmt(shipFee);
            $('#shipName').textContent = shipName;
            $('#grand').textContent = fmt(grand);
            $('#sumSub').textContent = fmt(subtotal);
            $('#sumShip').textContent = fmt(shipFee);

            const cnt = [...items.values()].reduce((a, b) => a + b.qty, 0);
            $('#summaryText').textContent = cnt ? `총 ${cnt}개 품목` : '항목이 없습니다';
        }

        function onMenuChange() {
            const sel = $('#menu');
            const opt = sel.selectedOptions[0];
            const name = sel.value;
            if (!name) return;

            if (name === '직접입력') {
                const n = (prompt('메뉴명을 입력하세요', '') || '').trim();
                if (!n) { sel.value = ''; return; }
                const p = Number(prompt('가격(원)을 입력하세요', '0'));
                if (!Number.isFinite(p) || p < 0) { sel.value = ''; return; }
                addOrIncItem(n, Math.round(p), 1);
            } else {
                addOrIncItem(name, Number(opt.dataset.price) || 0, 1);
            }
            sel.value = '';
        }

        // 통화 포맷
        const curKR = (n) => '₩' + (new Intl.NumberFormat('ko-KR').format(Math.max(0, Number(n) || 0)));

        // 인보이스 렌더 + 제목/시간
        function renderInvoice() {
            const orderName = $('#orderName')?.value?.trim() || '-';
            const orderPhone = $('#orderPhone')?.value?.trim() || '-';
            const orderEmail = $('#orderEmail')?.value?.trim() || '-';

            const recvName = $('#recvName')?.value?.trim() || orderName || '-';
            const recvPhone = $('#recvPhone')?.value?.trim() || orderPhone || '-';
            const addr = [
                $('#sample3_postcode')?.value,
                $('#sample3_address')?.value,
                $('#sample3_detailAddress')?.value,
                $('#sample3_extraAddress')?.value,
            ].filter(Boolean).join(' ');

            $('#invBillName').textContent = orderName;
            $('#invBillPhone').textContent = orderPhone;
            $('#invBillEmail').textContent = orderEmail;
            $('#invShipName').textContent = recvName;
            $('#invShipPhone').textContent = recvPhone;
            $('#invShipAddr').textContent = addr || '-';

            const memo = $('#memo')?.value?.trim();
            $('#invNotes').textContent = memo || '-';
            const shipSel = $('#shipping');
            const shipName = shipSel?.selectedOptions[0]?.value || '방문 수령';
            const shipFee = Number(shipSel?.selectedOptions[0]?.dataset?.fee) || 0;
            $('#invPayMethod').textContent = shipName;

            const tbody = $('#invItems');
            tbody.innerHTML = '';
            let sub = 0;
            (window.items ? [...items.values()] : []).forEach(it => {
                const amt = (Number(it.price) || 0) * (Number(it.qty) || 0);
                sub += amt;
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${it.name}</td>
          <td class="num">${it.qty}</td>
          <td class="num">${curKR(it.price)}</td>
          <td class="num">${curKR(amt)}</td>
        `;
                tbody.appendChild(tr);
            });
            $('#invSub').textContent = curKR(sub);
            $('#invShipFee').textContent = curKR(shipFee);
            $('#invTotal').textContent = curKR(sub + shipFee);

            // 신랑신부
            $('#invGroomName').textContent = $('#groomName')?.value?.trim() || '-';
            $('#invBrideName').textContent = $('#brideName')?.value?.trim() || '-';
            $('#invEventDate').textContent = $('#eventDate')?.value?.trim() || '-';

            // 상단 우측 현재 시간
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const stamp = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
            document.querySelector('#invoicePrint .tag').textContent = stamp;

            // 파일 제목: yymmdd_이름_첫상품
            const yy = String(now.getFullYear()).slice(2);
            const mm = pad(now.getMonth() + 1);
            const dd = pad(now.getDate());
            const firstItem = (window.items && [...items.values()][0]?.name) || '상품없음';
            document.title = `${yy}${mm}${dd}_${orderName || '이름없음'}_${firstItem}`;
        }

        // 출력용 HTML(iframe에 주입)
        function buildInvoiceHTML() {
            renderInvoice();
            const css = `
        @page{size:A4 portrait;margin:12mm;}
        @media print { html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
        body{font:12px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#0f172a;}
        /* 고정 폭: 화면 캡처 품질 일정하게 */
        .sheet{border:1px solid #e5e7eb;border-radius:12px;padding:14px; width:794px; margin:0 auto; background:#fff;}
        .topbar{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
        .brand{font-size:24px;font-weight:900;letter-spacing:.5px;}
        .tag{color:#ef4444;font-weight:900;letter-spacing:.5px;}
        .meta,.meta2{display:grid;gap:8px;margin:8px 0 14px;}
        .meta{grid-template-columns:1fr 1fr;}
        .meta2{grid-template-columns:1fr 1fr 1fr;}
        .box{border:1px solid #e2e8f0;border-radius:8px;padding:10px;background:#fff;}
        .box h4{margin:0 0 6px;font-size:12px;color:#334155;letter-spacing:.2px;}
        .kv{display:grid;grid-template-columns:110px 1fr;row-gap:4px;column-gap:8px;}
        table{width:100%;border-collapse:collapse;}
        thead th{font-size:11px;color:#334155;text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;}
        tbody td{padding:8px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
        .num{text-align:right;white-space:nowrap;}
        .totals{border:1px solid #e2e8f0;border-radius:8px;padding:10px;}
        .totals .row{display:grid;grid-template-columns:1fr auto;padding:6px 0;border-bottom:1px dashed #e5e7eb;}
        .totals .row:last-child{border-bottom:0;font-weight:800;}
        .tiny{font-size:11px;color:#64748b;}
      `;
            return `
        <!doctype html><html lang="ko"><head>
          <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
          <title>${document.title}</title>
          <style>html,body{margin:0;padding:0}${css}</style>
        </head><body>
            ${document.querySelector('#invoicePrint').innerHTML}
        </body></html>`;
        }

        // ⭐ 갤럭시/안드로이드 안전 프린트: 숨은 iframe 사용 (사용자 제스처 유지)
        function printInvoiceSafe() {
            const html = buildInvoiceHTML();

            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.right = '0';
            iframe.style.bottom = '0';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = '0';
            iframe.setAttribute('sandbox', 'allow-modals allow-same-origin allow-scripts');

            document.body.appendChild(iframe);

            if ('srcdoc' in iframe) {
                iframe.srcdoc = html;
            } else {
                const doc = iframe.contentWindow || iframe.contentDocument;
                const idoc = doc.document || doc;
                idoc.open(); idoc.write(html); idoc.close();
            }

            iframe.onload = () => {
                try {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                } catch (e) {
                    alert('이 기기에서 인쇄 대화상자를 열 수 없어요.');
                } finally {
                    setTimeout(() => document.body.removeChild(iframe), 1500);
                }
            };
        }

        // ⭐ 새로 추가: 외부 라이브러리 없이 SVG foreignObject로 깨끗한 PNG 내보내기
        async function exportInvoicePNG() {
            try {
                renderInvoice();
                // 1) 출력용 CSS (buildInvoiceHTML과 동일 폭/스타일)
                const css = `
        @page{size:A4 portrait;margin:12mm;}
        @media print { html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
        html,body{margin:0;padding:0}
        body{font:12px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#0f172a;background:#fff;}
        .sheet{border:1px solid #e5e7eb;border-radius:12px;padding:14px; width:794px; margin:0 auto; background:#fff;}
        .topbar{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
        .brand{font-size:24px;font-weight:900;letter-spacing:.5px;}
        .tag{color:#ef4444;font-weight:900;letter-spacing:.5px;}
        .meta,.meta2{display:grid;gap:8px;margin:8px 0 14px;}
        .meta{grid-template-columns:1fr 1fr;}
        .meta2{grid-template-columns:1fr 1fr 1fr;}
        .box{border:1px solid #e2e8f0;border-radius:8px;padding:10px;background:#fff;}
        .box h4{margin:0 0 6px;font-size:12px;color:#334155;letter-spacing:.2px;}
        .kv{display:grid;grid-template-columns:110px 1fr;row-gap:4px;column-gap:8px;}
        table{width:100%;border-collapse:collapse;}
        thead th{font-size:11px;color:#334155;text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;}
        tbody td{padding:8px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
        .num{text-align:right;white-space:nowrap;}
        .totals{border:1px solid #e2e8f0;border-radius:8px;padding:10px;}
        .totals .row{display:grid;grid-template-columns:1fr auto;padding:6px 0;border-bottom:1px dashed #e5e7eb;}
        .totals .row:last-child{border-bottom:0;font-weight:800;}
        .tiny{font-size:11px;color:#64748b;}
        `;

                // 2) 화면 밖에서 실제 렌더 높이를 먼저 계산
                const ghost = document.createElement('div');
                ghost.style.cssText = 'position:fixed;left:-10000px;top:-10000px;width:794px;visibility:hidden;';
                ghost.innerHTML = `<style>${css}</style>${document.querySelector('#invoicePrint').innerHTML}`;
                document.body.appendChild(ghost);
                const h = Math.ceil(ghost.querySelector('.sheet').getBoundingClientRect().height);
                const w = 794;

                // 3) SVG foreignObject로 HTML을 이미지로 변환 (폰트/라인 가장 깔끔)
                const svg = `<?xml version="1.0" encoding="UTF-8"?>
`+
                    `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">` +
                    `<foreignObject width="100%" height="100%">` +
                    `<div xmlns="http://www.w3.org/1999/xhtml"><style>${css}</style><div class="sheet">${document.querySelector('#invoicePrint').innerHTML}</div></div>` +
                    `</foreignObject></svg>`;

                const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const img = new Image();
                const scale = Math.min(3, (window.devicePixelRatio || 1) * 2);

                await new Promise((resolve, reject) => {
                    img.onload = () => resolve();
                    img.onerror = reject;
                    img.src = url;
                });

                const canvas = document.createElement('canvas');
                canvas.width = w * scale;
                canvas.height = h * scale;
                const ctx = canvas.getContext('2d');
                ctx.setTransform(scale, 0, 0, scale, 0, 0);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, w, h);
                ctx.drawImage(img, 0, 0);

                URL.revokeObjectURL(url);
                document.body.removeChild(ghost);

                const a = document.createElement('a');
                a.download = `${document.title || 'flovin_invoice'}.png`;
                a.href = canvas.toDataURL('image/png');
                a.click();
            } catch (e) {
                console.error(e);
                alert('이미지 변환에 실패했어.');
            }
        }

        // 이벤트 바인딩
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
            $('#category').addEventListener('change', (e) => updateMenuOptions(e.target.value));
            $('#menu').addEventListener('change', onMenuChange);
            $('#shipping').addEventListener('change', render);
            $('#clear').onclick = () => { items.clear(); render(); };

            $('#orderPhone').addEventListener('input', () => formatPhoneInput($('#orderPhone')));
            $('#recvPhone').addEventListener('input', () => formatPhoneInput($('#recvPhone')));
            $('#sameAsOrder').addEventListener('change', syncRecipientFromOrder);
            $('#orderName').addEventListener('input', () => { if ($('#sameAsOrder').checked) copyRecipient(); });
            $('#orderPhone').addEventListener('input', () => { if ($('#sameAsOrder').checked) copyRecipient(); });

            // 프린트 버튼(모든 플랫폼 공통)
            document.getElementById('btnPrint').onclick = () => { printInvoiceSafe(); };

            // 이미지 저장 버튼 (PNG 1종, 더 깔끔한 렌더링)
            document.getElementById('btnSaveImage').onclick = () => exportInvoicePNG();

            render();
        });
    </script>

    <!-- 카카오 우편번호 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        var element_wrap = document.getElementById('wrap');
        function foldDaumPostcode() { element_wrap.style.display = 'none'; }
        function sample3_execDaumPostcode() {
            var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
            new daum.Postcode({
                oncomplete: function (data) {
                    var addr = '';
                    var extraAddr = '';
                    if (data.userSelectedType === 'R') { addr = data.roadAddress; }
                    else { addr = data.jibunAddress; }
                    if (data.userSelectedType === 'R') {
                        if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) { extraAddr += data.bname; }
                        if (data.buildingName !== '' && data.apartment === 'Y') {
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        if (extraAddr !== '') { extraAddr = ' (' + extraAddr + ')'; }
                        document.getElementById("sample3_extraAddress").value = extraAddr;
                    } else {
                        document.getElementById("sample3_extraAddress").value = '';
                    }
                    document.getElementById('sample3_postcode').value = data.zonecode;
                    document.getElementById("sample3_address").value = addr;
                    document.getElementById("sample3_detailAddress").focus();
                    element_wrap.style.display = 'none';
                    document.body.scrollTop = currentScroll;
                },
                onresize: function (size) { element_wrap.style.height = size.height + 'px'; },
                width: '100%', height: '100%'
            }).embed(element_wrap);
            element_wrap.style.display = 'block';
        }
    </script>
</body>

</html>