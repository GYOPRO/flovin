<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title>주문서 - FLOVIN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#2563eb" />
    <link rel="manifest" href="/manifest.webmanifest">
    <style>
        :root {
            --ink: #111827;
            --muted: #6b7280;
            --line: #e5e7eb;
            --brand: #2563eb;
            --bg: #fff;
        }

        html,
        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        .wrap {
            max-width: 900px;
            margin: 32px auto;
            padding: 0 16px;
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid var(--line);
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .logo {
            font-size: 28px;
            font-weight: 900
        }

        .title {
            font-size: 20px;
            font-weight: 800
        }

        .card {
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
            padding: 14px;
            margin-bottom: 12px;
        }

        .grid {
            display: grid;
            gap: 12px
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .row-1 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px
        }

        label {
            display: block;
            font-size: 12px;
            color: #374151;
            margin-bottom: 6px
        }

        select,
        input,
        button {
            font: inherit
        }

        select,
        input[type="number"],
        input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 10px 12px;
            background: #fff
        }

        .muted {
            color: var(--muted)
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-weight: 700;
            font-size: 12px
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px
        }

        thead th {
            text-align: left;
            font-size: 12px;
            color: #374151;
            padding: 0 10px
        }

        tbody tr {
            background: #fafafa;
            border: 1px solid var(--line)
        }

        td {
            padding: 8px 10px;
            vertical-align: middle
        }

        tbody tr td:first-child {
            border-radius: 10px 0 0 10px
        }

        tbody tr td:last-child {
            border-radius: 0 10px 10px 0
        }

        .num {
            text-align: right
        }

        .btn {
            border: 1px solid var(--line);
            background: #f3f4f6;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer
        }

        .btn.small {
            padding: 4px 8px
        }

        .btn.danger {
            color: #ef4444;
            border-color: #f3d4d4;
            background: #fff8f8
        }

        .actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end
        }

        .total-bar {
            display: flex;
            justify-content: flex-end
        }

        .grand {
            background: #f8fafc;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 900;
            font-size: 18px;
            min-width: 260px;
            text-align: right
        }

        .grand .label {
            color: #374151;
            margin-right: 12px;
            font-weight: 700
        }

        @media (max-width:640px) {
            .row {
                grid-template-columns: 1fr
            }
        }

        @media print {
            .btn {
                display: none
            }

            .badge {
                background: #e5e7eb;
                color: #111
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <div class="logo">FLOVIN</div>
            <div class="title">주문서</div>
        </header>

        <!-- 메뉴 선택 -->
        <div class="card grid">
            <div class="row-1">
                <div>
                    <label>메뉴</label>
                    <select id="menu">
                        <option value="" data-price="0">선택하세요</option>
                        <option value="유리돔" data-price="100000">유리돔 - 100,000원</option>
                        <option value="액자" data-price="100000">액자 - 100,000원</option>
                        <option value="주얼박스" data-price="50000">주얼박스 - 50,000원</option>
                        <option value="직접입력" data-price="0">직접 입력</option>
                    </select>
                </div>
            </div>
            <div class="muted">메뉴 선택 시 아래 <b>주문내역</b>에 추가되고, 배송비 포함 총금액이 갱신돼.</div>
        </div>

        <!-- 배송방식 -->
        <div class="card grid">
            <div class="row">
                <div>
                    <label>배송방식</label>
                    <select id="shipping">
                        <option value="직접수령" data-fee="0">방문 수령 (0원)</option>
                        <option value="택배" data-fee="4000">택배 (4,000원)</option>
                    </select>
                </div>
                <div style="display:flex;align-items:center">
                    <span class="muted">* 유리돔은 파손 위험으로 <b>직접수령만</b> 가능</span>
                </div>
            </div>
        </div>

        <!-- 주문내역 -->
        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <span class="badge">주문내역</span>
                <span class="muted" id="summaryText"></span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>메뉴</th>
                        <th style="width:120px">단가</th>
                        <th style="width:160px">수량</th>
                        <th style="width:140px" class="num">금액</th>
                        <th style="width:120px"></th>
                    </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
            </table>

            <div class="actions" style="margin-top:8px">
                <button class="btn" id="clear">모두 비우기</button>
            </div>

            <div style="display:grid;gap:6px;margin-top:12px">
                <div class="num">소계: <b id="subtotal">0</b> 원</div>
                <div class="num">배송비(<span id="shipName">직접수령</span>): <b id="shipFee">0</b> 원</div>
            </div>
        </div>

        <!-- 총금액 -->
        <div class="total-bar">
            <div class="grand">
                <div><span class="label">총금액</span><span id="grand">0</span> 원</div>
                <div class="muted" style="font-size:12px;margin-top:4px">(소계 <span id="sumSub">0</span> + 배송비 <span
                        id="sumShip">0</span>)</div>
            </div>
        </div>

        <div class="actions" style="margin-top:12px">
            <button class="btn" id="btnPrint">인쇄 / PDF 저장</button>
            <button class="btn" id="btnInstall" style="display:none">앱 설치</button>
        </div>
    </div>

    <script>
        const nf = new Intl.NumberFormat('ko-KR');
        const $ = (s) => document.querySelector(s);

        // ===== 주문 상태 =====
        const items = new Map();
        const fmt = (n) => nf.format(Math.max(0, Number(n) || 0));

        function addOrIncItem(name, price, qty = 1) {
            if (!name) return;
            if (items.has(name)) items.get(name).qty += qty;
            else items.set(name, { name, price: Number(price) || 0, qty: Number(qty) || 1 });
            render();
        }
        function setQty(name, qty) {
            const it = items.get(name); if (!it) return;
            it.qty = Math.max(0, Number(qty) || 0);
            if (it.qty === 0) items.delete(name);
            render();
        }
        function removeItem(name) { items.delete(name); render(); }

        function totals() {
            let subtotal = 0;
            items.forEach(it => subtotal += it.price * it.qty);
            const shipOpt = $('#shipping').selectedOptions[0];
            const shipFee = Number(shipOpt?.dataset?.fee) || 0;
            const shipName = shipOpt?.value || '직접수령';
            return { subtotal, shipFee, shipName, grand: subtotal + shipFee };
        }

        function render() {
            const tbody = $('#itemsBody');
            tbody.innerHTML = '';
            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${it.name}</td>
          <td><input class="uprice" data-name="${it.name}" type="number" min="0" step="1" value="${it.price}" /></td>
          <td>
            <div style="display:flex;gap:6px;align-items:center">
              <button class="btn small" data-action="dec" data-name="${it.name}">-</button>
              <input class="qtyInput" data-name="${it.name}" type="number" min="0" step="1" value="${it.qty}" style="width:80px" />
              <button class="btn small" data-action="inc" data-name="${it.name}">+</button>
            </div>
          </td>
          <td class="num">${fmt(it.price * it.qty)}</td>
          <td class="num"><button class="btn danger small" data-action="del" data-name="${it.name}">삭제</button></td>`;
                tbody.appendChild(tr);
            });

            tbody.onclick = (e) => {
                const b = e.target.closest('button'); if (!b) return;
                const name = b.dataset.name;
                const it = items.get(name); if (!it) return;
                const act = b.dataset.action;
                if (act === 'inc') setQty(name, it.qty + 1);
                if (act === 'dec') setQty(name, it.qty - 1);
                if (act === 'del') removeItem(name);
            };
            tbody.oninput = (e) => {
                const q = e.target.closest('.qtyInput');
                const p = e.target.closest('.uprice');
                if (q) setQty(q.dataset.name, q.value);
                if (p) { const it = items.get(p.dataset.name); if (it) { it.price = Math.max(0, Number(p.value) || 0); render(); } }
            };

            const { subtotal, shipFee, shipName, grand } = totals();
            $('#subtotal').textContent = fmt(subtotal);
            $('#shipFee').textContent = fmt(shipFee);
            $('#shipName').textContent = shipName;
            $('#grand').textContent = fmt(grand);
            $('#sumSub').textContent = fmt(subtotal);
            $('#sumShip').textContent = fmt(shipFee);

            const cnt = [...items.values()].reduce((a, b) => a + b.qty, 0);
            $('#summaryText').textContent = cnt ? `총 ${cnt}개 품목` : '항목이 없습니다';
        }

        // 메뉴/배송 이벤트
        $('#menu').addEventListener('change', () => {
            const sel = $('#menu');
            const opt = sel.selectedOptions[0];
            const name = sel.value;
            if (!name) return;
            if (name === '직접입력') {
                const n = (prompt('메뉴명을 입력하세요', '') || '').trim();
                if (!n) { sel.value = ''; return; }
                const p = Number(prompt('가격(원)을 입력하세요', '0'));
                if (!Number.isFinite(p) || p < 0) { sel.value = ''; return; }
                addOrIncItem(n, Math.round(p), 1);
            } else {
                addOrIncItem(name, Number(opt.dataset.price) || 0, 1);
            }
            sel.value = '';
        });
        $('#shipping').addEventListener('change', () => render());
        $('#clear').addEventListener('click', () => { items.clear(); render(); });
        $('#btnPrint').addEventListener('click', () => window.print());

        // ===== PWA 등록 =====
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/sw.js").catch(console.warn);
            });
        }

        // 설치 버튼
        let deferredPrompt = null;
        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById("btnInstall");
            btn.style.display = "inline-block";
            btn.onclick = async () => {
                btn.style.display = "none";
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                }
            };
        });

        render();
    </script>
</body>

</html>